{% extends "layout.html" %}

{% block title %}
    Request Time
{% endblock %}

{% block main %}
<div class="container">
    <h1 class="mb-4">Request Time Slots</h1>
    
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Submit a New Time Request</h3>
        </div>
        <div class="panel-body">
            <form action="/instructor/request_time" method="post">
                <div class="form-group">
                    <label for="request_type">Request Type</label>
                    <select class="form-control" id="request_type" name="request_type" required>
                        <option value="open">Open Time Slot (Available to Teach)</option>
                        <option value="close">Close Time Slot (Not Available)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="date">Date</label>
                    <select class="form-control" id="date" name="date" required>
                        <option value="">Select a date</option>
                        {% for date in available_dates %}
                            <option value="{{ date.date }}" data-day="{{ date.date|strftime('%w') }}">{{ date.display }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="start_time_select">Start Time</label>
                    <select class="form-control" id="start_time_select" required disabled>
                        <option value="">Select a date first</option>
                    </select>
                    <input type="hidden" id="start_time" name="start_time">
                </div>
                
                <div class="form-group">
                    <label for="end_time_select">End Time</label>
                    <select class="form-control" id="end_time_select" required disabled>
                        <option value="">Select start time first</option>
                    </select>
                    <input type="hidden" id="end_time" name="end_time">
                </div>
                
                <div class="form-group">
                    <label for="reason">Reason (Optional)</label>
                    <textarea class="form-control" id="reason" name="reason" rows="3" placeholder="Provide a reason for your request"></textarea>
                </div>
                
                <div class="alert alert-info" id="workingHoursInfo">
                    <strong>Working Hours:</strong> Please select a date to see working hours.
                </div>
                
                <button type="submit" class="btn btn-primary" id="submitButton" disabled>Submit Request</button>
            </form>
        </div>
    </div>
    
    <div class="panel panel-default mt-4">
        <div class="panel-heading">
            <h3 class="panel-title">Pending Requests</h3>
        </div>
        <div class="panel-body">
            {% if pending_requests %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Reason</th>
                            <th>Submitted</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in pending_requests %}
                            <tr>
                                <td>{{ request.request_date }}</td>
                                <td>{{ request.start_time }} - {{ request.end_time }}</td>
                                <td>
                                    {% if request.request_type == 'open' %}
                                        <span class="label label-success">Open</span>
                                    {% else %}
                                        <span class="label label-danger">Close</span>
                                    {% endif %}
                                </td>
                                <td>{{ request.reason }}</td>
                                <td>{{ request.created_at }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="alert alert-info">No pending requests.</div>
            {% endif %}
        </div>
    </div>
    
    <div class="panel panel-default mt-4">
        <div class="panel-heading">
            <h3 class="panel-title">Recent Processed Requests</h3>
        </div>
        <div class="panel-body">
            {% if recent_requests %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Admin Note</th>
                            <th>Processed</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in recent_requests %}
                            <tr>
                                <td>{{ request.request_date }}</td>
                                <td>{{ request.start_time }} - {{ request.end_time }}</td>
                                <td>
                                    {% if request.request_type == 'open' %}
                                        <span class="label label-success">Open</span>
                                    {% else %}
                                        <span class="label label-danger">Close</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if request.status == 'approved' %}
                                        <span class="label label-success">Approved</span>
                                    {% else %}
                                        <span class="label label-danger">Rejected</span>
                                    {% endif %}
                                </td>
                                <td>{{ request.admin_note }}</td>
                                <td>{{ request.processed_at }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="alert alert-info">No processed requests.</div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Working hours by day of week
        var workingHours = {
            {% for day, hours in hours_by_day.items() %}
                {{ day }}: {
                    name: "{{ hours.name }}",
                    openTime: "{{ hours.open_time }}",
                    closeTime: "{{ hours.close_time }}",
                    isOpen: {{ 'true' if hours.is_open else 'false' }}
                },
            {% endfor %}
        };
        
        // Function to generate time options in 30-minute intervals
        function generateTimeOptions(startTime, endTime) {
            var options = [];
            var current = new Date('2000-01-01T' + startTime + ':00');
            var end = new Date('2000-01-01T' + endTime + ':00');
            
            // Add times in 30-minute intervals
            while (current < end) {
                var hours = current.getHours();
                var minutes = current.getMinutes();
                
                // Format hours and minutes
                var formattedHours = hours < 10 ? '0' + hours : hours;
                var formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
                var timeValue = formattedHours + ':' + formattedMinutes;
                
                // Format for display (12-hour format with AM/PM)
                var displayHours = hours % 12 || 12;
                var ampm = hours < 12 ? 'AM' : 'PM';
                var displayTime = displayHours + ':' + formattedMinutes + ' ' + ampm;
                
                options.push({
                    value: timeValue,
                    display: displayTime
                });
                
                // Add 30 minutes
                current.setMinutes(current.getMinutes() + 30);
            }
            
            return options;
        }
        
        // Update time options when date is selected
        $('#date').change(function() {
            var dateValue = $(this).val();
            
            // Reset time selects
            $('#start_time_select').empty().append('<option value="">Select a time</option>').prop('disabled', true);
            $('#end_time_select').empty().append('<option value="">Select start time first</option>').prop('disabled', true);
            $('#start_time').val('');
            $('#end_time').val('');
            $('#submitButton').prop('disabled', true);
            
            if (dateValue) {
                var date = new Date(dateValue);
                var dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
                
                // Convert to our format (0 = Monday, 6 = Sunday)
                dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                
                var hours = workingHours[dayOfWeek];
                
                if (hours) {
                    if (hours.isOpen) {
                        $('#workingHoursInfo').html('<strong>Working Hours:</strong> ' + hours.name + ' ' + hours.openTime + ' - ' + hours.closeTime);
                        $('#workingHoursInfo').removeClass('alert-danger').addClass('alert-info');
                        
                        // Generate time options
                        var timeOptions = generateTimeOptions(hours.openTime, hours.closeTime);
                        
                        // Populate start time dropdown
                        $('#start_time_select').empty().append('<option value="">Select a start time</option>');
                        
                        $.each(timeOptions, function(i, time) {
                            $('#start_time_select').append(
                                $('<option></option>')
                                    .attr('value', time.value)
                                    .text(time.display)
                            );
                        });
                        
                        // Enable start time select
                        $('#start_time_select').prop('disabled', false);
                    } else {
                        $('#workingHoursInfo').html('<strong>Note:</strong> The ski school is closed on ' + hours.name + '.');
                        $('#workingHoursInfo').removeClass('alert-info').addClass('alert-danger');
                    }
                } else {
                    $('#workingHoursInfo').html('<strong>Working Hours:</strong> Not set for this day.');
                    $('#workingHoursInfo').removeClass('alert-danger').addClass('alert-info');
                }
            } else {
                $('#workingHoursInfo').html('<strong>Working Hours:</strong> Please select a date to see working hours.');
                $('#workingHoursInfo').removeClass('alert-danger').addClass('alert-info');
            }
        });
        
        // Update end time options when start time is selected
        $('#start_time_select').change(function() {
            var startTimeValue = $(this).val();
            
            // Reset end time select
            $('#end_time_select').empty().append('<option value="">Select an end time</option>').prop('disabled', true);
            $('#end_time').val('');
            $('#submitButton').prop('disabled', true);
            
            if (startTimeValue) {
                // Set the hidden input value
                $('#start_time').val(startTimeValue);
                
                var dateValue = $('#date').val();
                var date = new Date(dateValue);
                var dayOfWeek = date.getDay();
                dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                var hours = workingHours[dayOfWeek];
                
                if (hours && hours.isOpen) {
                    // Generate time options starting from the selected start time + 30 minutes
                    var startTimeParts = startTimeValue.split(':');
                    var startHour = parseInt(startTimeParts[0]);
                    var startMinute = parseInt(startTimeParts[1]);
                    
                    // Create a new date object for the start time
                    var startDate = new Date('2000-01-01T' + startTimeValue + ':00');
                    
                    // Add 30 minutes to get the minimum end time
                    startDate.setMinutes(startDate.getMinutes() + 30);
                    var minEndHour = startDate.getHours();
                    var minEndMinute = startDate.getMinutes();
                    var minEndTime = (minEndHour < 10 ? '0' + minEndHour : minEndHour) + ':' + 
                                    (minEndMinute < 10 ? '0' + minEndMinute : minEndMinute);
                    
                    // Generate time options from minimum end time to closing time
                    var timeOptions = generateTimeOptions(minEndTime, hours.closeTime);
                    
                    // Populate end time dropdown
                    $('#end_time_select').empty().append('<option value="">Select an end time</option>');
                    
                    $.each(timeOptions, function(i, time) {
                        $('#end_time_select').append(
                            $('<option></option>')
                                .attr('value', time.value)
                                .text(time.display)
                        );
                    });
                    
                    // Enable end time select
                    $('#end_time_select').prop('disabled', false);
                }
            }
        });
        
        // Update hidden input and enable submit button when end time is selected
        $('#end_time_select').change(function() {
            var endTimeValue = $(this).val();
            
            if (endTimeValue) {
                // Set the hidden input value
                $('#end_time').val(endTimeValue);
                
                // Enable submit button
                $('#submitButton').prop('disabled', false);
            } else {
                $('#end_time').val('');
                $('#submitButton').prop('disabled', true);
            }
        });
    });
</script>
{% endblock %}