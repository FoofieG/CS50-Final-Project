{% extends "layout.html" %}

{% block title %}
    Lesson Calendar
{% endblock %}

{% block main %}
<div class="container">
    <h1 class="mb-4">Lesson Calendar</h1>
    
    <!-- Week Navigation -->
    <div class="row mb-3">
        <div class="col-md-12 text-center">
            <div class="btn-group">
                {% if week_offset > 0 %}
                <a href="/admin/lesson_calendar?week={{ week_offset - 1 }}" class="btn btn-default">
                    <span class="glyphicon glyphicon-chevron-left"></span> Previous Week
                </a>
                {% endif %}
                
                <a href="/admin/lesson_calendar?week=0" class="btn btn-default {% if week_offset == 0 %}active{% endif %}">
                    Current Week
                </a>
                
                <a href="/admin/lesson_calendar?week={{ week_offset + 1 }}" class="btn btn-default">
                    Next Week <span class="glyphicon glyphicon-chevron-right"></span>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Calendar View -->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                Week of {{ dates[0].display }} - {{ dates[6].display }}
            </h3>
        </div>
        <div class="panel-body">
            <div class="calendar-container">
                <!-- Calendar Header (Days) -->
                <div class="row calendar-header">
                    <div class="col-md-1 calendar-time-column">
                        <div class="calendar-time-header">Time</div>
                    </div>
                    {% for day in dates %}
                    <div class="col-md-1dot5 calendar-day-column">
                        <div class="calendar-day-header {% if loop.index0 == 0 or loop.index0 == 6 %}weekend{% endif %}">
                            <div class="day-name">{{ day.day_name }}</div>
                            <div class="day-date">{{ day.display }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Calendar Body (Hours) -->
                <div class="calendar-body">
                    {% for hour in range(6, 23) %}  <!-- 6 AM to 10 PM -->
                    <div class="row calendar-hour-row">
                        <div class="col-md-1 calendar-time-column">
                            <div class="calendar-time">
                                {{ '%02d' % hour }}:00
                            </div>
                        </div>
                        
                        {% for day in dates %}
                        <div class="col-md-1dot5 calendar-day-column">
                            <div class="calendar-cell {% if loop.index0 == 0 or loop.index0 == 6 %}weekend{% endif %}">
                                {% for lesson in calendar_data[day.date] %}
                                    {% if lesson.start_hour <= hour and lesson.end_hour > hour %}
                                        {% set top_position = 0 %}
                                        {% set height_percentage = 100 %}
                                        
                                        {% if lesson.start_hour == hour %}
                                            {% set top_position = (lesson.start_minute / 60) * 100 %}
                                            {% set height_percentage = 100 - top_position %}
                                        {% endif %}
                                        
                                        {% if lesson.end_hour == hour + 1 %}
                                            {% set height_percentage = (lesson.end_minute / 60) * 100 %}
                                        {% endif %}
                                        
                                        <div class="calendar-event lesson-event" 
                                             style="top: {{ top_position }}%; height: {{ height_percentage }}%;"
                                             data-toggle="tooltip" 
                                             title="{{ lesson.customer }} with {{ lesson.instructor }}">
                                            {% if lesson.start_hour == hour %}
                                                <div class="event-time">{{ lesson.start_time }}</div>
                                                <div class="event-title">{{ lesson.customer }}</div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            {% set has_lessons = false %}
            {% for date_lessons in calendar_data.values() %}
                {% if date_lessons|length > 0 %}
                    {% set has_lessons = true %}
                {% endif %}
            {% endfor %}
            
            {% if not has_lessons %}
            <div class="alert alert-info text-center mt-3">
                <p>No lessons scheduled for this week.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* Calendar Styles */
    .calendar-container {
        overflow-x: auto;
    }
    
    .calendar-header {
        font-weight: bold;
        border-bottom: 1px solid #ddd;
        margin-bottom: 0;
    }
    
    .calendar-time-column {
        width: 80px;
        min-width: 80px;
        max-width: 80px;
    }
    
    .col-md-1dot5 {
        width: 12.5%;
        float: left;
        position: relative;
        min-height: 1px;
        padding-right: 15px;
        padding-left: 15px;
    }
    
    .calendar-day-column {
        border-left: 1px solid #ddd;
    }
    
    .calendar-time-header, .calendar-day-header {
        padding: 8px;
        text-align: center;
    }
    
    .calendar-day-header.weekend {
        background-color: #f9f9f9;
    }
    
    .day-name {
        font-weight: bold;
    }
    
    .day-date {
        font-size: 12px;
        color: #777;
    }
    
    .calendar-hour-row {
        height: 60px;
        border-bottom: 1px solid #eee;
        margin-left: 0;
        margin-right: 0;
    }
    
    .calendar-time {
        padding: 8px;
        text-align: right;
        color: #777;
        font-size: 12px;
    }
    
    .calendar-cell {
        height: 60px;
        position: relative;
        border-left: 1px solid #eee;
    }
    
    .calendar-cell.weekend {
        background-color: #f9f9f9;
    }
    
    .calendar-event {
        position: absolute;
        left: 0;
        right: 0;
        padding: 2px 4px;
        font-size: 11px;
        border-radius: 2px;
        overflow: hidden;
        cursor: pointer;
        opacity: 0.9;
    }
    
    .calendar-event:hover {
        opacity: 1;
    }
    
    .lesson-event {
        background-color: #5bc0de;
        color: white;
    }
    
    .event-time {
        font-weight: bold;
    }
    
    .event-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .mt-3 {
        margin-top: 15px;
    }
    
    .mb-3 {
        margin-bottom: 15px;
    }
    
    .mb-4 {
        margin-bottom: 20px;
    }
</style>

<script>
    $(document).ready(function(){
        // Initialize tooltips
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>
{% endblock %}